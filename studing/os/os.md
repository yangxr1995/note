# 环境搭建

```bash
apt install gcc-i686-linux-gnu gdb cmake qemu-system-x86 
```

# boot

##  从BIOS到boot

主板固化的BIOS程序会完成硬件自检，并加载boot，运行boot

        ┌────┐      ┌────────┐        ┌─────┐       ┌───┐
        │BIOS├─────►│BIOS自检├───────►│boot ├──────►│os │
        └────┘      └────────┘        └─────┘       └───┘

具体启动流程
- BIOS启动boot
  - BIOS检查硬盘是否为启动分区
    - 启动分区的第一个block最后两个字节为0xAA, 0x55
  - BIOS加载启动分区第一个block到内存的0x7c00
  - BIOS跳转到0x7c00开始执行boot
- boot启动os
  - boot加载系统镜像的剩余部分到内存
  - boot继续执行

                      最后两个字节为
                      0xAA, 0x55
                          ▲
                          │
                     ┌────├────────────────────────────────────────┐
        硬盘         │    │           剩余部分                     │
                     └──┬─└─────────────────────────┬──────────────┘
                        │          BIOS加载第一块   │    boot加载剩余部分
                        └───────────────┐           └─────┐
                                        ▼                 ▼
                     ┌────────────────┌────┌─────────────────────────────────┌──────────────────────────┐
        内存         │ 栈空间         │    │         剩余部分                │                          │
                     ├────────────────├────└─────────────────────────────────└──────────────────────────┘
                     ▼                ▼
                     0               0x7c00

## i386 体系结构

### 通用寄存器

        32                 16         8        0
         ┌──────────────────┬─────────┬────────┐
         │                  │  AH     │  AL    │  AX(16bit)  EAX(32bit)
         ├──────────────────┼─────────┼────────┤
         │                  │  BH     │  BL    │  BX(16bit)  EBX(32bit)
         ├──────────────────┼─────────┼────────┤
         │                  │  CH     │  CL    │  CX(16bit)  ECX(32bit)
         ├──────────────────┼─────────┼────────┤
         │                  │  DH     │  DL    │  DX(16bit)  EDX(32bit)
         ├──────────────────┼─────────┴────────┤
         │                  │       BP         │  BP(16bit)  EBP(32bit)
         ├──────────────────┼──────────────────┤
         │                  │       SI         │  SI(16bit)  ESI(32bit)
         ├──────────────────┼──────────────────┤
         │                  │       DI         │  DI(16bit)  EDI(32bit)
         ├──────────────────┼──────────────────┤
         │                  │       SP         │  SP(16bit)  ESP(32bit)
         └──────────────────┴──────────────────┘
         
## 段寄存器         
因为早期寄存器支持16bit，能访问的地址最大为0xffff，最大空间为64k，
所以设计了段加偏移地址的方式访问内存,
实际访问内存的地址: (段寄存器的值左移 << 4) + 通用寄存器

              ┌──────────┐
              │          │
              ├──────────┤
              │          │ 0x7c0:32
    ┌────────►│ 代码段   │◄───────────────┐
    │         │          │                │
    │  0x7c00 ├──────────┤                │
    │         │          │                │            16                  0       
    │         │          │                │             ┌──────────────────┐       
    │         ├──────────┤                └─────────────┤       CS         │ 代码段
    │         │          │ 0x300:44                     ├──────────────────┤       
    │         │ 数据段   │◄─────────────────────────────┤       DS         │ 数据段
    │         │          │                              ├──────────────────┤       
    │  0x3000 ├──────────┤                ┌─────────────┤       SS         │ 栈段  
    │         │          │                │             ├──────────────────┤       
    │         │          │                │             │       ES         │ 数据段
    │         ├──────────┤                │             ├──────────────────┤       
    │         │  栈      │ 0x100:56       │             │       FS         │ 数据段
    │         │          │◄───────────────┘             ├──────────────────┤       
    │  0x1000 ├──────────┤                              │       GS         │ 数据段
    │         │          │                              └──────────────────┘       
    │         │          │
    │       0 └──────────┘                           
    │                                                
    │                       32                  16              0                                                                                                                                           
    │                        ┌──────────────────┬────────────────┐                                                                                                                                          
    └────────────────────────┤                  │   IP           │ 指令指针寄存器 IP(16bit) EIP(32bit) 
                             └──────────────────┴────────────────┘                                     

             ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐
             │     │     │ OF  │     │ IF  │     │     │ PF  │     │ CF  │  程序状态和控制寄存器
             └─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘

## 保护模式和实模式



